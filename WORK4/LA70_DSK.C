   #include   <math.h>
   #include   <dos.h>
   #include   <io.h>
   #include   <stdio.h>
   #include   <conio.h>
//   #include   <stdlib.h>
   #include   <string.h>

#define outB      outportb
#define outW      outport
#define inpB      inportb
#define inpW      inport

#define words
#define bytes
#define Kbytes
#define blocks
#define items
#define each

#define PORTION         0x1000 bytes
#define SECND_DONE     (SINGLE_BUF_SIZE & counter)  // counter Ú DIM/2
#define FIRST_not_DONE   SECND_DONE                 // counter Ú DIM/2
#define FIRST_DONE     (!SECND_DONE)                // counter < DIM/2
#define SECND_not_DONE (!SECND_DONE)                // counter < DIM/2

// ‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹
// € Interrupt Handlers Support €€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€
// ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ
#define TIMER_FR      1193820L
#define GET_T2_COUNT  asm{ push ax;                                       \
                           mov al,80h; out 43h,al; nop;nop;nop;           \
                           in al,42h;  mov ah,al;  nop;nop;nop;           \
									in al,42h;  xchg ah,al;                        \
									mov T2Count,ax; pop ax; }
#define STORE_T2_COUNT T2pCount = T2Count
#define GET_DELAY      T2Delay = T2pCount - T2Count
#define IRQ0_MISS_NUM (T2Delay/Tcounter)

#define MASK1         0x21
#define BLOCK         64 Kbytes
/*
ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ
IRQ  XT             AT            IRQ  (2-nd 8259A)
ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ
  0  timer          timer        ⁄  8  real time clock
  1  keyboard       keyboard     ≥  9  soft.redirected to IRQ2
  2  reserved    *  I/O channel µ 10  reserved
  3  COM1        *  COM2         ≥ 11  reserved
  4  COM2        *  COM1         ≥ 12  reserved
  5  fixed disk  *  LPT2         ≥ 13  x87 coprocessor
  6  diskette       diskette     ≥ 14  fixed disk
  7  LPT1           LPT1         ¿ 15  reserved
ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ
*/
#define WORKING_MASK  0xD8   /* ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø
                              ≥  1101.1000 enables : KBD and      ≥
                              ≥  XT - Tmr & reserved & fixed disk ≥
                              ≥  AT - Tmr & I/O channel & LPT2    ≥
                              ¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ */

/*	_BX=(int)IRQ0_MISS_NUM;       \
	_CX=_BX;                      \
	for(; _CX>2; _CX--)           \
	{                             \
		*BUF_POINTER++=5000;       \
		counter--;                 \
	}                             \
*/
#define ADC_BODY {                if( !Tmissing )  \
{                                                  \
	_DX=hig_port;                                                             \
	outB( _DX,                                                                \
         Channel_new_number);     /* next Channel setting ‡†ß‡•Ë†•‚ éÇï:   */\
                                  /* §Æ ·‚†‡‚† ØÆ Ì‚Æ¨„ ™†≠†´„ ≠† ¢ÂÆ§•    */\
                                  /* éÇï ·®£≠†´ §Æ´¶•≠ „·‚†≠Æ¢®‚Ï·Ô, Á‚Æ°Î */\
                                  /* ≠• °Î´Æ ¨•¶™†≠†´Ï≠Æ£Æ Ø‡Æ≠®™†≠®Ô     */\
                                  /*                                    ≥  */\
   _AH = inpB(_DX) & 0x0f;        /* READ of previously                 ≥  */\
   _DX--;                         /* started digityzing                 ≥  */\
   _AL = inpB(_DX);               /*                                    ≥  */\
   *BUF_POINTER++ = _AX;          /* Bufferization                      ≥  */\
                                  /*                                    ≥  */\
   outB( _DX, _AL );              /* START ØÆ „·‚†≠Æ¢´•≠≠Æ¨„ ™†≠†´„ ƒƒƒƒŸ  */\
   counter --;                                                               \
																									  \
   old_index = new_index;                                                    \
   new_index = (new_index+1)%Nchans;                                         \
   Channel_new_number = Channel[new_index];                                  \
};                                          /* end if( !Tmissing )         */\
	Tmissing = (Tmissing+1)%TmissIni;                                         \
	}
// ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ
   void set_cur_lock(int,int,int);
   #define LINE      32
   #define CURPOS 			((unsigned int far *)MK_FP(0x40,0x50))
   #define TYPE_PROGRESS	if(!((++num)%piece)){putchar('€'); BarNum++;}
	#define SAVE_CURPOS		{cRow = (CURPOS[0]>>8); cCol = CURPOS[0]&0xff;}
	#define SET_CURPOS(C,R)	set_cur_loc(C,R,0)
// ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ
   char  OldMask1;
	unsigned int cRow, cCol;
   void  interrupt    (*Old_Timer_Intr)(void);   // BIOS timer
   void  interrupt    (*Old_Int15_Hndl)(void);   // Device Bisy Loop
   void  interrupt    (*Old_Int76_Hndl)(void);   // Hard Disk IRQ

// ‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹
// € Internal prototypes €€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€
// ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ
   void *tcalloc(int elsize, int sizeof_el);
   void tfree( void *address);
// ‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹
// € Error support €€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€
// ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ
   #define  error_return(x) {                                            \
	SET_CURPOS(cCol,cRow);                                                \
            printf("\n\7éË®°™† %s",ErrMsg[x]);                           \
            if(handler+1){                                               \
            chsize(handler, tell(handler));                              \
            close(handler);};                /* ß†™‡Î‚Ï ‰†©´           */\
            if(buf0!=NULL)tfree(buf0);       /* Æ·¢Æ°Æ§®‚Ï Ø†¨Ô‚Ï      */\
            return(x);}
	#define  exit_if_error {                                              \
				if(ErrNum){ Disable_Acquisition(); error_return(ErrNum);};}

   char         *ErrMsg[]={
               "0 - Ø‡Æ£‡†¨¨† ß†¢•‡Ë•≠† „·Ø•Ë≠Æ",
               "1 - ≠• ¨Æ£„ ‡†ß¨•·‚®‚Ï ‰†©´ ß†Ø‡ÆË•≠≠Æ£Æ ‡†ß¨•‡† ≠† §®·™•",
               "2 - ≠• ¨Æ£„ ‡†ß¨•·‚®‚Ï °„‰•‡ §†≠≠ÎÂ ¢ Ø†¨Ô‚®",
               "3 - User's Ctrl-Break",
               "4 - ≠•„·Ø•¢ ß†Ø®·® ·¢Æ°Æ§≠Æ£Æ °„‰•‡†",
					"5 - ·´®Ë™Æ¨ ¢Î·Æ™†Ô Á†·‚Æ‚† ÆØ‡Æ·†",
					"6 - ·´®Ë™Æ¨ ≠®ß™†Ô Á†·‚Æ‚† ÆØ‡Æ·†"
               },
               ErrNum=0;
// ÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕ
   unsigned char
         low_byte, hig_byte;
   int   low_port, hig_port;
// ‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹
// € Arguments €€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€
// ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ
   char unsigned  res_name[128]="ps.dat";
   float          FREQ=10000.;              // Á†·‚Æ‚† ÆÊ®‰‡Æ¢™®
   long unsigned  //FREQ=10000,               // Á†·‚Æ‚† ÆÊ®‰‡Æ¢™®
                  rate;                     // ≠•Æ°Â.Ø•‡®Æ§ ß†Ø„·™† ¢ ‚®™†Â
   int unsigned   Base_Address = 0,         // 0 §´Ô ™Æ≠‚‡Æ´Ô †‡£„¨•≠‚†
                  VOLUME       = 1 blocks,  // Æ°Í•¨ ¢ °´Æ™†Â
				  REM_SIZE	   = 0,			// Æ·‚†‚Æ™ (≠•Ê•´Î© °´Æ™) ¢ Æ‚·Á.
                  SINGLE_BUF_SIZE  words ;  // ‡†ß¨•‡ Æ§®≠ÆÁ≠Æ£Æ °„‰•‡†
   long unsigned  DIM              words ;  // Æ°È®© ‡†ß¨•‡ §¢Æ©≠Æ£Æ °„‰•‡†
   char unsigned  wait_flag=0; /* if(!VOLUME && RES_SIZE) ¨Æ£„ ≠• „·Ø•‚Ï Æ‚´Æ¢®‚Ï
								  Ø•‡•ÂÆ§ counter Á•‡•ß RES_SIZE */

// ÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕ
   int unsigned
         far *BUF_POINTER,        // Ø•‡•¨•≠≠Î© „™†ß†‚•´Ï ƒƒø
         counter=0xffff,          // offset-·Á•‚Á®™ §´Ô ƒƒƒƒƒŸ 64 KB !!!
         Tcounter,                // counter §´Ô ·®·‚•¨≠Æ£Æ ‚†©¨•‡†
			TmissIni=1,              // Ø‡ÆØ„·™Æ¢ IRQ0 +1 (§´Ô ≠®ß™®Â Á†·‚Æ‚)
			Tmissing,                // ·Á•‚Á®™ Ø‡ÆØ„·™Æ¢ IRQ0
         T2Delay,                 // ‚•™„È®© ≠• Æ°Ôß-≠Æ ·‚†≠Æ¢®‚·Ô ØÆ·´•§≠®¨
         T2pCount,                // ØÆ·´•§≠®© ƒ¬ƒ counter for Timer2
         T2Count,                 // ‚•™„È®©   ƒŸ (check missed Timer IRQ)
         Nchans=1,                // ™Æ´®Á•·‚¢Æ ™†≠†´Æ¢
         old_index = 0,           // ®≠§•™· ¢ ¨†··®¢• ≠Æ¨•‡Æ¢ ™†≠†´Æ¢
         new_index = 0;           // ®≠§•™· ¢ ¨†··®¢• ≠Æ¨•‡Æ¢ ™†≠†´Æ¢
   char  Channel_new_number,      // ≠Æ¢Î© ≠Æ¨•‡ ™†≠†´†
         Channel[16];             // ¨†··®¢ ≠Æ¨•‡Æ¢ ™†≠†´Æ¢
// ‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹
// € New Interrupt Handler Functions €€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€
// ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ
   char unsigned DeviceBisyLoop=0;
   int unsigned far *scr,inn=0,outt=0;
   int cbrk_hnd(void);

   void  interrupt   New_Int15_Hndl(void)
// ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ
{
   asm{  cmp ah,90h; je  DBL;
         cmp ah,91h; je  FNI;
         jmp OtherFun; }
DBL:                                   // Device Bisy Loop
/*
	GET_T2_COUNT; GET_DELAY;
	if((int)IRQ0_MISS_NUM>0 )
	{
		*BUF_POINTER++=5000; counter--;
//		T2Delay-=Tcounter;
//		STORE_T2_COUNT;
//		ADC_BODY;
	}
//	scr[800+(inn++)]=0x7020+IRQ0_MISS_NUM;
*/
   DeviceBisyLoop++;
   asm   cmp DeviceBisyLoop,1;         // can be modified only by Int15 FNI
   asm   jne EndIntr;                  // DBL ¨Æ¶•‚ °Î‚Ï ÆØ„È•≠ Ñé ‚Æ£Æ !!!
DBL1:
   scr[0]++;
   asm   sti;                          // wait hardware interrupt
	asm   hlt;
	asm   cli;
   asm   cmp DeviceBisyLoop,1;         // can be modified only by Int15 FNI
   asm   je  DBL1;                     // to preserve from CLI
   asm   jmp EndIntr;
FNI:                                   // Finish Interrupt
   scr[81]++;
/*
	GET_T2_COUNT; GET_DELAY;
	if((int)IRQ0_MISS_NUM>0 )
	{
		*BUF_POINTER++=6000; counter--;
//		STORE_T2_COUNT;
//		T2Delay-=Tcounter;
//		ADC_BODY;
	}
//	scr[960+(outt++)]=0x7020+IRQ0_MISS_NUM;
*/
   DeviceBisyLoop--;
   asm   jmp EndIntr;
OtherFun:                              // Other Functions
EndIntr:                               // End Interrupt
	;
}
// ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ
	char ncr=0;
   void  interrupt   New_Timer_Intr(void)
// ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ
{
/*	GET_T2_COUNT; GET_DELAY;
	STORE_T2_COUNT;
*/
	ADC_BODY;
   outB(0x20,0x20);
}
// End interrupt
// ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ
// ‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹
// € Functions €€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€
// ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ
   void near Disable_Acquisition(void)
// ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ
{
   disable();
   outB( MASK1, 0xFF );                // disable all IRQ from 8259
	outB( 0x20, 0xC7 );                 // restore default priorities: 7=less

   // ¢Æ··‚†≠Æ¢®‚Ï Ø‡•¶≠®• ¢•™‚Æ‡†

   setvect( 0x08, Old_Timer_Intr);
   setvect( 0x15, Old_Int15_Hndl);  DeviceBisyLoop = 0;

   outB(0x43,0x36);                    // Timer0 <- 18.2 Hz
   outB(0x40,0xFF); outB(0x40,0xFF);

   outB( MASK1, OldMask1 );            // ‡•£®·‚‡ ¨†·™® 8259
   outB(0x43,0x74);
   outB(0x41,( char) 18 );             // Timer1 (refresh) previous state
   outB(0x41,( char)  0 );

   enable();
}
// ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ
   int near Enable_Acquisition(void)
// ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ
{
   low_port = Base_Address+4;
   hig_port = Base_Address+5;

// Á†·‚Æ‚† ß†Ø„·™† ‚†©¨•‡† ® ™Æ´®Á•·‚¢Æ Ø‡ÆØ„·™†•¨ÎÂ IRQ0

	{  long unsigned T;
		for(T=rate; T>=0x4000L; TmissIni++) T = rate/TmissIni;
 		Tcounter = (int unsigned) T;
	}

	if(Tcounter<40)    {ErrNum=5; return 1;};     // ??? FREQ > 30 kHz

   disable();

   // Save IRQ Mask

   OldMask1 = inpB( MASK1 );           // preserve 1st 8259 mask
   outB( MASK1, 0xFF );                // disable all IRQ from 8259
	outB( 0x20, 0xC0 );                 // to make HD more sign.: IRQ0=less

   // Timer Settings

   if(Tcounter<4096)
   {                                   // Timer1 (refresh) syncronization
         outB(0x43,0x74);
         outB(0x41,( char) (Tcounter & 0xff) );
         outB(0x41,( char)((Tcounter & 0xff00) >> 8));
   }

   outB(0x43,0x36);                    // New Timer0 counter = rate/TmissIni
   outB(0x40,(unsigned char)Tcounter);
   outB(0x40,(unsigned char)(Tcounter>>8));

   // Ø‡•§¢†‡®‚•´Ï≠Î© START ØÆ Ø•‡¢Æ¨„ ®ß ¢Î°‡†≠≠ÎÂ ™†≠†´Æ¢:
   // §•´†•‚·Ô §´Ô Ø‡†¢®´Ï≠Æ·‚® ØÆ·´•§„ÓÈ•© ‡†°Æ‚Î New_Timer_Intr

   new_index = 0;
   old_index = new_index;
   Channel_new_number=Channel[new_index];
	Tmissing = 0;
	ADC_BODY; BUF_POINTER--; counter++;

   outB(0x43,0xB6);                    // Timer2 <- 18.2 Hz
   outB(0x42,0xFF); outB(0x42,0xFF);
	outB(0x61,(char)(~2)&(1|inpB(0x61)));  // open GATE, disable SOUND

	GET_T2_COUNT;
	STORE_T2_COUNT;

   // Hooked Vectors Setting

   Old_Timer_Intr = getvect(0x08);     // ·ÆÂ‡†≠®‚Ï ·‚†‡Î© Timer0 Handler
   setvect( 0x08, New_Timer_Intr);     // „·‚†≠Æ¢®‚Ï ≠Æ¢Î© Timer0 Handler

   Old_Int15_Hndl = getvect(0x15);     // ·ÆÂ‡†≠®‚Ï ·‚†‡Î© DBL/FNI
   setvect( 0x15, New_Int15_Hndl);     // „·‚†≠Æ¢®‚Ï ≠Æ¢Î© DBL/FNI

//   outB( MASK1, WORKING_MASK);         // 1111.1010 enables only Tmr & 2nd 8259
   enable();
	return 0;
}
// ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ
   int near PS_available(void)
// ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ
{  int i;
   int bases[8]={0x200,0x210,0x220,0x230,0x300,0x310,0x320,0x330};
   for(i=0; i<8; i++)
   {
      outportb(bases[i]+5,13);       // „·‚†≠†¢´®¢†Ó ™†≠†´
      if( ( inportb(bases[i]+5)>>4 ) // ·‚†‡Ë®© ØÆ´„°†©‚ §Æ´¶•≠ °Î‚Ï ‡†¢•≠
               != 13 )               // „·‚†≠Æ¢´•≠≠Æ¨„ ≠Æ¨•‡„ ™†≠†´†
      continue;
      return(bases[i]);
   }
   return(0);                        // PS not available
}
// ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ
   int unsigned far *buf0=NULL, far* not_written=0;
   int handler=-1;        			// data output file
   int main(int Nargs, char *arg[])
// ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ
{
   int unsigned
            far *buf1=NULL,       // ¨†··®¢ ·Æ°®‡†•¨ÎÂ §†≠≠ÎÂ
            far *buf2=NULL,
            far *buf11=NULL,
            far *buf21=NULL;
   int      i;

   scr = MK_FP(0xb800,0);
   Channel[0]=0;
   #include "ch_psdsk.c"

// ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ
   buf0 = tcalloc(SINGLE_BUF_SIZE items, 4 bytes each);// DIM ØÆ 2 = 64 KB !!!
   if(buf0==NULL) error_return(2);
   buf1 = buf0;                                       // preserve for tfree
// ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ
   buf2 = buf1 + SINGLE_BUF_SIZE words;     // offs = 32 KB
   buf11 = buf1 + SINGLE_BUF_SIZE/2 words;  // offs = 16 KB
   buf21 = buf2 + SINGLE_BUF_SIZE/2 words;  // offs = 48 KB
   BUF_POINTER = buf1;
// ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ
   handler =
   _creat(res_name,FA_ARCH);      // create new / overwrite existing one

// ß†‡•ß•‡¢®‡Æ¢†‚Ï ¨•·‚Æ ≠† §®·™•
   printf("\rWait...");
   if(
      chsize(handler, (VOLUME blocks) * (2L*DIM bytes each) + REM_SIZE*2L)
     ) error_return(1);

   lseek(handler,0L,SEEK_SET);    // „™†ß†‚•´Ï ‰†©´† - ≠† ≠†Á†´Æ

   { float persec;
	{  long unsigned T,TI=1; float rrate;
		for(T=rate; T>=0x4000L; TI++) T = rate/TI;
		rrate=(float)T*TI;
        FREQ = TIMER_FR/rrate; // really loaded freq
	}
   persec = (float)FREQ/512;
   printf(
     "\r             ÃÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕµ"
     "\n             ∫  Å†ßÆ¢Î© †§‡•·    %x         	  ≥"
	 "\n             ∫  é°Í•¨ §†≠≠ÎÂ     %u °´Æ™Æ¢  	  ≥"
	 "\n             ∫  ê†ß¨•‡ °´Æ™†     %u KB      	  ≥"
	 "\n             ∫  èÆ´≠Æ• ¢‡•¨Ô     %.1f ·•™„≠§	  ≥"
	 ,
	Base_Address,
   VOLUME,BLOCK,(float)(VOLUME*BLOCK*1.024+(float)REM_SIZE/512)/persec);
   printf(
	 "\n             ∫  ó†·‚Æ‚† ÆØ‡Æ·†   %.*f ÉÊ     	  ≥"
	 ,
   (FREQ<.01)?3:(FREQ<.1)?2:(FREQ<1.)?1:0, FREQ);
   printf(
	 "\n             ∫  ó®·´Æ ™†≠†´Æ¢    %i         	  ≥"
	 "\n             ∫  èÆ‚Æ™ §†≠≠ÎÂ     %.1f KB/·•™	  ≥"
     "\n             «ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥"
	 "\n             ∫                                    ≥"
	 "\n             ”ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒŸ"
	 "\n\nPress any key to start\7",
   Nchans,persec);
   getch();
	printf("\r                      ");
   }
// ÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕ
   {  int unsigned
			piece, num=0, BarNum=0, line=LINE;

      char far *PAGE0;

   piece = (VOLUME*4)/LINE; if(!piece) line=VOLUME*4;
   piece += 1;

	SAVE_CURPOS;
	SET_CURPOS(cCol-6,cRow-3);
   for(i=1; i<=line; i++) putchar('±');
	SET_CURPOS(cCol-6,cRow-3);
// ÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕ
   if(Enable_Acquisition()) error_return(ErrNum);     // REAL START
   not_written=buf1;
   ctrlbrk(cbrk_hnd);	// only AFTER Enable_Acq
 if (VOLUME) {
   outB( MASK1, WORKING_MASK);         // 1111.1010 enables only Tmr & 2nd 8259
   while(1)
   {
   // ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ
      TYPE_PROGRESS;
      while(FIRST_not_DONE)
	  {	asm HLT; scr[3]++;   // ¶§„ ß†ØÆ´≠•≠®Ô Ø•‡¢Æ£Æ °„‰•‡†
		if(kbhit()) getch();
	  }

      outB( MASK1, WORKING_MASK|2); // disable CBRK while writingƒƒƒƒƒƒø
      _write( handler, buf1, SINGLE_BUF_SIZE bytes);                 //≥
                                                                     //≥
      exit_if_error;                                                 //≥
      TYPE_PROGRESS;                                                 //≥
      if(SECND_DONE) ErrNum=4;              // ·≠Æ¢† ß†ØÆ´≠Ô•‚ FIRST   ≥
      exit_if_error;                                                 //≥
                                                                     //≥
      _write( handler, buf11, SINGLE_BUF_SIZE bytes);                //≥
      not_written = buf2;          // BUF_PTR > buf2                   ≥
      outB( MASK1, WORKING_MASK);  // enable CBRK after writingƒƒƒƒƒƒƒƒŸ
      exit_if_error;
   // ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ
      TYPE_PROGRESS;
      while(SECND_not_DONE) {asm HLT; scr[4]++;  // ¶§„ ß†ØÆ´≠•≠®Ô ¢‚Æ‡Æ£Æ °„‰•‡†
		if(kbhit()) getch();
	  }

      outB( MASK1, WORKING_MASK|2); // disable CBRK while writingƒƒƒƒƒƒø
      _write( handler, buf2, SINGLE_BUF_SIZE bytes);                 //≥
      exit_if_error;                                                 //≥
      TYPE_PROGRESS;                                                 //≥
      if(FIRST_DONE) ErrNum=4;              // ·≠Æ¢† ß†ØÆ´≠Ô•‚ SECND   ≥
      exit_if_error;                                                 //≥
                                                                     //≥
      _write( handler, buf21, SINGLE_BUF_SIZE bytes);                //≥
      not_written = buf1;                                            //≥
      outB( MASK1, WORKING_MASK);  // enable CBRK after writingƒƒƒƒƒƒƒƒŸ
      exit_if_error;
   // ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ
      VOLUME--;
      if(!VOLUME) break;
   }
 } else wait_flag=1;

   if (REM_SIZE)
   {
	  short unsigned cmp=0xffff-REM_SIZE;
   // ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ
      TYPE_PROGRESS;
	  if (wait_flag) outB( MASK1, WORKING_MASK);
      while(counter>=cmp) {asm HLT; scr[3]++;  // ¶§„ ß†ØÆ´≠•≠®Ô Æ·‚†‚™† °„‰•‡†
		if(kbhit()) getch();
	  }
      _write( handler, buf1, REM_SIZE*2U bytes);
   // ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ
   }
   for(; BarNum<line; BarNum++) putchar('€');
   }
   if(kbhit()) if(!getch()) getch();
// ÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕ
// ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ
   Disable_Acquisition();
   error_return(ErrNum);
}


   int cbrk_hnd()
// ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ
   {
    Disable_Acquisition();
	SET_CURPOS(cCol,cRow);
    printf("\n\7User't Ctrl-Break");
    if(handler+1){
	   if (BUF_POINTER>not_written)
      _write( handler, not_written, (BUF_POINTER-not_written)*2U bytes);
    chsize(handler, tell(handler));
    close(handler);};
    if(buf0!=NULL)tfree(buf0);
    return(0);
   }
// ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ
