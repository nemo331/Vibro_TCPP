
                 PSV Tools 1.0, Chernyshyov V.Yu.


                LA70 Fast Disk Acquisition Utility
                 Version 1.07, PSV Tools, 1992-93


       Утилита непрерывного сбора на винчестер LA70_DSK.EXE


0. Содержание.

1. Назначение.
2. Ограничения при использовании.
3. Инсталляция и запуск из системы DOS.
4. Опции командной строки.
4.1. Короткая подсказка.
4.2. Имя файла.
4.3. Выбор каналов АЦП (ключ /C).
4.4. Выбор базового адреса (ключ /A).
4.5. Выбор частоты запусков АЦП (ключ /R).
4.6. Объем собираемой информации (ключ /V).
4.7. Примеры использования ключей.
5. Использование созданного файла.
6. Сопутствующие утилиты.


1. Назначение.

Предназначена для длительного НЕПРЕРЫВНОГО сбора зкспериментальных
данных на жесткий диск персонального компьютера посредством платы
сбора данных LA70.

Примером задачи может служить многочасовой сбор информации с
нескольких датчиков, контролирующих состояние медленно меняющегося
процесса (разогрев или охлаждение теплового реактора,
технологический контроль химического производства, снятие
кардиограммы и т.д.).

Утилита становится необходимой, когда требуемый объем данных не
умещается полностью в предоставляемую системой свободную
оперативную память, которая составляет обычно 400-450 килобайт.
Поэтому приходится периодически осбождать используемую для сбора
оперативную память, делая ее копию на жесткий диск (винчестер).

При решении такой задачи неискушенный пользователь как правило
сталкивается с трудоемкой проблемой: в системе должны бескофликтно
сосуществовать два процесса (сбор данных в RAM и запись данных из
RAM на жесткий диск), которые используют два существенно
разнородных ресурса персонального компьютера:

     ■ сбор осуществляется по прерыванию системного таймера 8254
     (расположен на системной плате персонального компьютера);
     ■ запись на винчестер должна производиться по мере заполнения
     RAM-буфера (по окончании цикла записи освобожденная часть
     буфера опять может быть использована для дальнейшего сбора
     данных).

Предлагаемая утилита осуществляет управление платой сбора данных и
записью на винчестер так, что максимально использует возможности
операционной системы и персонального компьютера.
Утилита непрерывного сбора на винчестер PSV_DSK.EXE


2. Ограничения при использовании.

Однако даже при наиболее оптимальном программировании описанных
процессов могут возникать ситуации, приводящие к ахронизму запуска
и/или даже пропуску некоторых отсчетов.

Экспериментально было установлено, что ахронизм запусков не
оказывает заметного влияния на качество собираемых утилитой данных
(пропусков при этомнет) при общей частоте запуска АЦП 1.2 кГц для
DOS5.0 (опция командной строки/RF1200) и 3 кГц для DOS3.3
(/RF3000). Тестирование производилось на системной плате AT-286 /
8 MHz.

При суммарном объеме собираемой информации (ключ /V... командной
строки) менее 1 блока (64 килобайта или 32768 отсчетов) все
описанные ограничения, связанные с ахронизмом и пропусками,
снимаются. Запись на винчестер в этом случае будет производиться
лишь по завершении процесса сбора данных в оперативную память
компьтера.


3. Инсталляция и запуск из системы DOS.

Утилита должна получить всю необходимую для ее работы информацию
через опции командной строки (ключи). Формат вызова утилиты
следующий: на приглашение DOS'а в командной строке нужно набрать

   LA70_DSK.EXE [имя файла] [/ключ1] [/ключ2]...

если утилита находится в текущем каталоге (или в переменной
DOS'овского окружения PATH указан каталог, в котором она
находится) или

   имя_каталога\LA70_DSK.EXE [имя файла] [/ключ1] [/ключ2]...

где 'имя_каталога'- каталог, в котором находится утилита.
Например, если утилита была инсталлирована в каталог с именем
D:\ADIX\PSV, то ее вызов будет выглядеть следующим образом:

   D:\ADIX\PSV\LA70_DSK.EXE [имя файла] [/ключ1] [/ключ2]...

Чтобы сделать вызов утилиты более коротким (как в первом примере),
нужно модифицировать файл AUTOEXEC.BAT в корневом каталоге
системного диска: в строку с описанием переменной окружения
(environment) PATH добавить запись D:\ADIX\PSV;. Если в исходном
состоянии эта строка имеет вид

   PATH=C:\;C:\DOS;C:\SYS;C:\NC;

то в результате модификации она должна выглядеть так

   PATH=C:\;C:\DOS;C:\SYS;C:\NC;D:\ADIX\PSV;


4. Опции командной строки.

4.1. Короткая подсказка.

Краткое описание всех возможных опций командной строки (подсказка)
может бытьполучено путем запуска утилиты с ключом '/?':

Утилита непрерывного сбора на винчестер PSV_DSK.EXE


   LA70_DSK.EXE /?

Программа выдаст описание на экран и вернет управление
интерпретатору DOS'а. Каждый параметр имеет значение по умолчанию
(by default): запуск утилиты без параметров эквивалентен следующей
командной строке

   LA70_DSK.EXE PS.DAT /C0 /RF10000 /VB1

или

   la70_dsk.exe ps.dat /c0 /rf10000 /vb1

4.2. Имя файла.

ИМЯ ФАЙЛА, в который пользователь хочет собирать данные,
обязательно должно стоять первым параметром командной строки. Если
файл не существует, он будет создан; если существует - будет
уничтожен (без предупреждения) и создан заново. Если имя файла не
указано, по умолчанию будет использовано имя PS.DAT (файл будет
создан в текущем каталоге). Если Вы хотите создать файл с именем
AAA.DAT в другом каталоге (например, D:\ADIX\DATA), достаточно
указать имя файла вместе с именем каталога или путем ('путь'=
англ.'path'):

   LA70_DSK.EXE D:\ADIX\DATA\AAA.DAT

Формат файла и примеры его чтения приведены ниже (в разделе
'Использование созданного файла').

Все остальные опции командной строки являются ключами, порядок их
следования не имеет значения.

4.3. Выбор каналов АЦП (ключ /C).

Плата сбора данных LA70 предоставляет возможность работы с 16-ю
каналами. Утилита написана таким образом, что позволяет
использовать любое количество каналов, причем можно устанавливать
любой порядок их переключения. Следующие два примера запуска
программы оба используют все 16 каналов (номера должны задаваться
в шестнадцатиричном виде):

   LA70_DSK.EXE /С0123456789abcdef
   LA70_DSK.EXE /Сfedcba9876543210

в первом случае порядок переключения прямой, во втором - обратный.
В общем случае порядок может быть любой (например,
/С0a2b3c4d5e6f,- 12 каналов в указанном порядке). В файле отсчеты
будут располагаться в соответствии с порядком запуска (а не
номером канала). Утилита ограничивает количество символов,
следующих за ключом /C, величиной 16 (decimal). Описанный способ
задания каналов очень удобен, когда Вам нужно по какому-либо
каналу выборку производить чаще:

   LA70_DSK.EXE /С0102

Здесь опрос канала 0 будет произведен дважды за один цикл
переключения каналов, что ПОЛНОСТЬЮ эквивалентно удвоению частоты
опроса этого канала (см. ниже 'Выбор частоты запусков АЦП').

Утилита непрерывного сбора на винчестер PSV_DSK.EXE


4.4. Выбор базового адреса (ключ /A).

Утилита в состоянии сама определить базовый адрес платы сбора
данных LA70. Поэтому ключ /A, как правило, не используется. Он
становится необходимым, когда Ваш персональный компьютер оснащен
более, чем одной платой сбора данных LA70. В этом случае базовые
адреса плат должны быть различны (иначе система не сможет работать
корректно: на один сигнал шины будут откликаться два различных
физических устройства). Поэтому, собирая информацию, Вы должны
знать, с каким именно устройством будет работать утилита. Если в
компьютере установлены два устройства LA70 (с различными
адресами), и при запуске базовый адрес не указан, программа будет
работать с первым обнаруженным адаптером (это будет плата с
меньшим базовым адресом).

Возможные значения базового адреса (шестнадцатиричные):
200,210,220,230,300, 310,320,330. Пример выбора платы с базовым
адресом 330:

   LA70_DSK.EXE /A330

 Если утилита не обнаружит плату с указанным адресом, она
переходит к автоматическому определению базового адреса.
Фактически обнаруженный базовый адрес будет выдан на экран перед
началом сбора.

4.5. Выбор частоты запусков АЦП (ключ /R).

С помощью ключа /R (Rate) задается интервал между запусками АЦП.
Ключ имеет несколько модификаторов (F,I,C), с помощью которых
утилита распознает способ задания частоты опроса АЦП. Если Вы
хотите запустить АЦП на частоте 1 кГц по нулевому каналу,
достаточно ввести на приглашение DOS строку

   LA70_DSK.EXE /C0 /RF1000.0

 Такое же задание частоты при многоканальном сборе (например, по
двум каналам)

   LA70_DSK.EXE /C01 /RF1000.0

 не изменит общего времени сбора, что будет равнозначно
пропорциональному (числу каналов) уменьшению частоты опроса для
каждого отдельно взятого канала. Следует отметить, что, как при
одноканальном, так и при многоканальном сборе (для двух последних
примеров) прерывание системного таймера происходит с частотой 1
кГц (интервал 1 мс), процедура обработки прерывания устанавливает
новый канал (из списка опции /C), читает результат предыдущего
преобразования и производит старт АЦП по вновь установленному
каналу. В обоих случаях старты АЦП будут отстоять друг от друга на
1 мс, причем во втором случае они будут поочередно соответствовать
то нулевому, то первому каналу (/C01). Это означает, что для
каждого канала частота запуска равна 500 Гц (интервал между
стартами нулевого канала равен 2 мс).

В последнем примере ключ можно было использовать с модификатором
C: /RC500 (Rate per Channel 500 Hz). Задание темпа через /RС
эквивалентно /RF, если частоту умножить на число каналов:

   la70_dsk /c012 /rc1000
   la70_dsk /c012 /rf3000

Утилита непрерывного сбора на винчестер PSV_DSK.EXE


 Темп опроса может быть задан через интервал между запусками (в
тиках системного таймера) с помощью модификатора I (/RI1194 <=>
Rate Interval 1194 ticks). При этом следует помнить, что входная
частота таймера = 1193820 Гц (1 тик = 838 нс, 1000 Гц <=> 1194
тиков). Дробное число тиков задавать нельзя.

Максимально возможное значение интервала - 15 минут (в ключе /RI
ставится величина = 2^30-1, где знак '^'- возведение в степень).

По умолчанию значение частоты устанавливается равным 9968 Гц (119
тиков). Точная установка частоты невозможна из-за дискретности
установки счетчика таймера 8254.

4.6. Объем собираемой информации (ключ /V).

Утилита позволяет гибко задавать количество требуемых пользователю
данных через ключ /V:
     VS... - в секундах,
     VM... - в минутах,
     VH... - в часах,
     VN... - в отсчетах (на 1 канал),
     VB... - в блоках (по 64 KB).

Например:

   la70_dsk /vn16        - по 16 отсчетов/канал (по умолч.1 канал
   => 16 отсчетов)
   la70_dsk /vh1         - собирать в течение часа

4.7. Примеры использования ключей.

   la70_dsk /c34 /vn16   - по 2 каналам (3й и 4й) по 16
   отсчетов/канал
   la70_dsk /rf1 /vh1    - на частоте 1 Гц собирать в течение часа
   la70_dsk /rf0.1       - на частоте 0.1 Гц собирать 64 KB
   la70_dsk /rf.01 /vs100     - на частоте 0.01 Гц собирать 100
   секунд


5. Использование созданного файла.

ФОРМАТ КОДА, записываемого в файл, эквивалентен коду,
производимому аналого-цифровым преобразователем. Имея два байта на
один отсчет и 12 значимых разрядов, он может рассматриваться как
простое 16-разрядное целое - со знаком или без знака,- в обоих
случаях величина кода будет лежать в диапазоне от 0 до 4095.
Максимальный код соответствует MAX напряжению, минимальный код -
минимальному напряжению:

         decimal    octal     hex.                 binary

MAX код     4095    07777     0FFF    0000 1111 1111 1111
            4094    07776     0FFE    0000 1111 1111 1110
            4093    07775     0FFD    0000 1111 1111 1101
            ....    .....     ....    ...................
               3       03        3    0000 0000 0000 0011
               2       02        2    0000 0000 0000 0010
               1       01        1    0000 0000 0000 0001
MIN код        0        0        0    0000 0000 0000 0000

Утилита непрерывного сбора на винчестер PSV_DSK.EXE


Каждому отсчету в файле соответствует двухбайтная запись: сначала
записан младший байт отсчета, затем - старший. Файл является
прямым дампом (dump - копия) RAM-буфера, в который производится
чтение данных из АЦП. Данные могут быть извлечены из файла
стандартными библиотечными функциями бинарного чтения из файла.
Пример чтения файла на языке C:

   #include <stdio.h>
   short int buf[128]; // 2 байта на отсчет
   void main()
   {
      FILE* F=fopen("PS.DAT","rb"); // открыть для чтения в BIN-
   моде
      fread(buf,2,128,F); // читать в buf 128 раз по 2 байта из F
      .....         // обработка данных
   }
   

При многоканальном сборе (смотри выше ключ /C) отсчеты будут
располагаться в файле в соответствии с порядком следования
каналов. Если сбор был произведен по трем каналам (например: 0,1,2
или 7,6,5), то файл можно условно рассматривать как состоящий из
последовательности 6-байтных (6=3канала*2байта/отсчет) секций, в
каждой секции первые 2 байта соответствуют каналу 0 (или 7),
вторые 2 байта - каналу 1 (или 6), третьи 2 байта - каналу 2 (или
5). Пример чтения такого файла на языке C:

   #include <stdio.h>
   #define EACH_SIZE 128
   #define SIZE EACH_SIZE*3
   short int buf[SIZE], buf0[EACH_SIZE]; // 2 байта на отсчет
   #define data(i,k) buf[i+3*k]
   void main()
   {  int k;
      FILE* F=fopen("PS.DAT","rb"); // открыть для чтения в BIN-
   моде
      fread(buf,2,SIZE,F); // читать в buf SIZE раз по 2 байта из
   F
      for (k=0; k<EACH_SIZE;k++)
         buf0[k]=data(0,k); // данные для канала 0 (или 7)
   }


6. Сопутствующие утилиты.

Для проверки функционирования АЦП LA70 и правильности сбора данных
утилитой LA70_DSK.EXE в комплект поставки платы сбора данных LA70
входят две утилиты: QUICK.EXE и DATVIEW.EXE.

QUICK.EXE.

Предназначена для быстрого просмотра сигналов, подаваемых на входы
LA70. Программа работает в режиме одноканального осциллоскопа (без
синхронизации) на заданной пользователем частоте опроса.
Одновременно на экран выводятся 256 точек собранных данных по
одному из выбранных каналов. Как и LA70_DSK.EXE утилита позволяет
работать одновременно с несколькими каналами (переключение каналов
в рабочем режиме - клавишей TAB). Утилита имеет ключ короткой
подсказки (/?), способ задания каналов и частоты полностью
аналогичен утилите LA70_DSK.EXE. Дополнительный ключ служит для
выбора используемого графического адаптера (EGA или VGA). Очень

Утилита непрерывного сбора на винчестер PSV_DSK.EXE


удобна при совместном использовании с LA70_DSK.EXE. Поместив вызов
утилит в один BAT-файл (например, с именем RUN.BAT):

   quick %1 %2 /vga
   la70_dsk %1 %2 %3

Вы можете затем запускать RUN.BAT, передавая ему параметры
командной строки для QUICK.EXE и LA70_DSK.EXE:

   run.bat /c012 /rf1000 /vb1

Это позволит пользователю перед длительным сбором данных на
винчестер удостовериться в правильности подключения входного
разъема и наличии сигналов на выбранных входах АЦП и только после
этого проинициировать выполнение сбора данных.

Управляющие клавиши (в рабочем режиме):
TAB       переключение на следующий из выбранных каналов;
Gray+          увеличение вдвое вертикального масштаба
(относительно средней точки - кода 2048);
Gray-          уменьшение вдвое вертикального масштаба;
Backspace сброс вертикального масштаба в исходное состояние
(диапазон от 0 до 4096).

DATVIEW.EXE.

Предназначена для быстрого просмотра данных, собранных платой
сбора данных LA70 с помощью утилиты LA70_DSK.EXE. Программа
работает в режиме одноканального просмотра. Одновременно на экран
выводятся 256 точек собранных данных по одному из выбранных
каналов. Как и LA70_DSK.EXE утилита позволяет работать
одновременно с несколькими каналами (переключение каналов в
рабочем режиме - клавишей TAB). Утилита имеет ключ короткой
подсказки (/?). Дополнительный ключ служит для выбора
используемого графического адаптера (EGA или VGA). Очень удобна
при совместном использовании с LA70_DSK.EXE. Поместив вызов утилит
в один BAT-файл (например, с именем RUNV.BAT):

   la70_dsk %1 %2 /c012
   datview /n3 /vga

Вы можете затем запускать RUNV.BAT, передавая ему параметры
командной строки для LA70_DSK.EXE:

   runv.bat /rf1000 /vb1

Это позволит пользователю после длительного сбора данных на
винчестер удостовериться в правильности произведенного сбора и в
случае ошибок оперативно решать вопрос о необходимости хранения
созданного файла.

Утилита имеет ограничение на количество представляемых за один
сеанс данных; из большого файла она прочитает лишь первые 64
килобайта данных.

Управляющие клавиши (в рабочем режиме):
TAB       переключение на следующий из выбранных каналов;
Gray+          увеличение вдвое вертикального масштаба
(относительно средней точки - кода 2048);
Gray-          уменьшение вдвое вертикального масштаба;
Backspace сброс вертикального масштаба в исходное состояние
(диапазон от 0 до 4096);

Утилита непрерывного сбора на винчестер PSV_DSK.EXE


Left      сдвинуть окно отображения (шириной 256 точек) на 8 точек
влево;
Right          сдвинуть окно отображения на 8 точек вправо;
Ctrl-Left сдвинуть окно отображения на 256 точек влево;
Ctrl-Right     сдвинуть окно отображения на 256 точек вправо;
Ctrl-Home сдвинуть окно отображения в начало прочитанного буфера
(64 KB);
Ctrl-End  сдвинуть окно отображения в конец буфера (64 KB).
